## 1	概述
同城双活技术方案是指数据库集群跨可用区部署，服务器跨可用区访问，且可同时读写（参考第4小节），该方案有以下特点：

- 主可用区数据库节点彻底故障，另一可用区数据库节点自动接管服务。
- 两可用区服务器均通过本可用区(相当于本地局域网)网络同时读写数据库实例。
- 实例对外仅保留唯一的虚拟IP；如果主可用区故障，虚拟IP不变且自动漂移到另一可用区。


## 2	支持情况

- **数据库版本**：已支持 CDB for MariaDB，Percona（仅限白名单用户）。
- **实例版本**：一主一从，一主二从。
- **网络要求**：仅支持VPC网络，基础网络不支持跨可用区部署。

## 3	创建流程与注意事项
### 3.1	创建实例



### 3.2	实例初始化


### 3.3	查看详情
您可以在实例详情页面，查看购买主从实例说在可用区的详情。

### 3.4	主从切换功能
您可以将主所在节点进行切换，以更好适应您。

**切换会导致数据库连接中断，请确保您的业务有重连机制。**


## 4	技术原理简介
### 4.1	设计标准
数据库同城双活解决方案是参考GB/T 20988-2007《信息系统灾难恢复规范》第6级，GB/T 22239-2008《星星系统安全等级保护基本要求》三级/四级 标准设计，**数据库双活的设计标准为RTO≤60秒，RPO≤5秒。**

**需要说明的，业务层的同城双活不仅是技术方案，还包括恢复策略、管理措施、资源要求、建设标准、恢复预案等一系列要求。**即使数据库实现双活，也并不意味着在灾难时业务可以完全正常的切换。包括某些重金打造的双活机房，主机房故障时“手软”的例子更是不胜枚举。究其根源，单纯硬件和软件方案很难完全解决业务连续性问题才是关键。事实上，大多数业务系统切换到灾备中心容易，但业务内部的关联、数据的完整性、配置和管理的复杂度，都是让决策者不敢切换的主要原因；因此，构建双活业务系统，需要业务在系统的设计、使用、管理、系统升级过程中时刻都以双中心为基础，双中心实时使用，这样才能做到故障后，业务做较少修改和配置，即可快速恢复运行。

### 4.2	方案技术原理
MariaDB采用主从架构，Master节点可读写， Slave可读（通过[只读账号]( /document/product/237/2081)实现读写分离）；主从节点为跨可用区部署，通过数据库主从协议自动实现数据实时同步。另外，我们在MariaDB的前端部署一组 （与数据库节点数量相同）Proxy做透明转发； Proxy会将客户端的请求转发到对应的节点，例如写请求会转发到Master节点，读请求转发到Slave节点。
VPC网关也实现跨可用区部署，这就意味着服务器可以VPC网关访问本可用区（本地局域网）内的数据库集群节点（实际上访问的是Proxy）；我们再此处支持了“IP漂移”特性，这就意味着VPC子网分配给实例唯一的虚拟IP后，两台（处于不同子网，但是相同VPC）的服务器，可以采用唯一的虚IP访问到MariaDB（实际上是访问Proxy）实现读写。

 **架构如下简述：**
 

这里的数据库同城双活解决方案，应对大多数异常情况：

1. 若Master节点彻底故障，集群自动选举最优slave提升为新Master，虚IP不变，业务仅感知部分写连接中断。
1. 若Slave节点彻底故障，集群可将读请求自动转发到Master以保证业务正常运行，并自动重建Slave节点，业务仅感知部分读连接中断。
1. 若A可用区完全故障，VPC、数据库集群在B可用区仍然存活，此时，slave2节点自动提升为Master，VPC网络IP漂移到B可用区；此时集群将自动重建Slave，业务感知仅部分写连接中断；此时不需要业务修改数据库配置，即可快速回复业务正常运行。
1. 假设B机房完全故障，MariaDB集群相当于故障了Slave节点，处理方法与2）相同。
1. 节点级故障，系统将自动重试恢复节点，并将恢复的重新加入集群（原Master节点恢复后，将以Slave节点身份加入，不会主动发生主从切换）。如果系统节点彻底故障无法恢复，将利用公有云中冗余设备，通过冷备重建节点。


> 请注意：金融围拢独享集群数据库方案将优先确保物理隔离，只会利用围拢内的数据库冗余设备恢复，而不会利用公有云的设备。
> 目前我们支持基于同城的灾难恢复演练。
