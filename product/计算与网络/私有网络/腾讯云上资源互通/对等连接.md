## 简介
VPC 对等连接是一种用于办公数据同步的跨VPC网络互联服务，可以使私有网络 IP 在对等 VPC 之间路由流量，就像它们属于同一网络一样。您可以实现同地域或跨地域的相同/不同用户的私有网络互联，通过在两端配置路由策略，可以实现不同私有网络的流量互通。对等连接不依赖某个独立硬件，因而不存在单点故障或带宽瓶颈。


## 对等连接互通性不传递
对等连接使私有网络之间两两建立互联，但是这种互通关系不发生传递。例如，如下图所示，VPC 1 与 VPC 2 建立了对等连接，VPC 1 和 VPC 3 也建立了对等连接。然而由于对等连接的不传递性，VPC 2 和 VPC 3 的流量不能互通。
![](http://imgcache.tcecqpoc.fsphere.cn/image/mccdn.qcloud.com/static/img/9127397dcb1df231bfd8d32bcd628223/image.png)
>注：即使建立了对等连接，如果两端没有配置发包、回包路由，也无法实现通信。


## 同地域对等连接 和 私有网络跨地域对等连接

同地域对等连接主要用于打通同地域处于不同私有网络中的应用。
跨地域的对等连接的典型应用场景是：**跨地域容灾**，通过跨地域对等连接实现不同地域的私有网络数据互通，快速部署两地三中心容灾方案，大带宽高可靠，满足金融级网络容灾需求。

## 建立和删除流程

### 对等连接建立流程
![](http://imgcache.tcecqpoc.fsphere.cn/image/mccdn.qcloud.com/static/img/9527bab04ca5213bdd72dbec99c9e9ef/image.png)

### 对等连接删除流程
![](http://imgcache.tcecqpoc.fsphere.cn/image/mccdn.qcloud.com/static/img/0e0ae950ebface4e307cd510de2b885e/image.png)

## 使用约束
关于对等连接，有以下几点您需要注意：
- 要使对等连接两端实现真正的通信，您必须在发起端和接收端的相关路由表上配置指向对端的路由规则。
- 如果对方不接受对等连接请求，申请将在7天后自动过期失效。
- 请不要接受来自您不了解账户的对等连接申请，此类用户可能对您的网络带来风险。
- 对等连接的两端私有网络 CIDR 不可以重叠，重叠时创建会报错。
- 跨地域对等连接时，一个 VPC 的多个对等网络间 CIDR 不可重叠，重叠时会报错。
- 对等连接任意一方可以随时中断对等连接。中断后两个私有网络间流量则立即中断。
- 同地域对等连接无带宽上限，跨地域对等连接用户需要设定带宽上限。


| 资源 | 限制 | 说明|
|---------|---------|---------|
| 每个私有网络支持的对等连接数 |10 |　|

更多VPC其他服务限制可以查看[VPC其它服务限制](/document/product/215/537)。



## 操作指南

### 快速入门
VPC跨地域通信以及跨账号通信都是对等连接的高级功能，您可以通过以下步骤创建对等连接来实现跨账号和跨地域通信。

- 同账号创建对等连接通信需要2步：
  第一步：创建对等连接。
  第二步：在两端设置路由表。
	
- 跨账号创建对等连接通信需要3步：
  第一步：创建对等连接。
  第二步：接受对等连接。
  第三步：在两端设置路由表。

示例：
网段1：**广州**的VPC1中子网A`192.168.1.0/24`。
网段2: **上海**的VPC2中子网B`10.0.1.0/24`。
通过对等连接实现网段1和网段2互通需要以下步骤：
![](http://imgcache.tcecqpoc.fsphere.cn/image/mc.qcloudimg.com/static/img/4817a68077ccf82022ea167476871c41/3.jpg)
#### 第1步：创建对等连接
1) 登录[云平台控制台](http://console.tcecqpoc.fsphere.cn/)，点击导航条【私有网络】。
2) 在私有网络控制台选择【对等连接】选项卡，在列表上方选择**地域：广州**，私有网络`VPC1`，然后点击【新建】，创建对等连接。
3) 输入名称（如：`PeerConn`）、选择对端**地域：上海**、对端账户类型及对端私有网络`VPC2`。

- 当对端账户类型为“ 我的账户 ”时，直接从下拉列表中选择。
- 当对端账户类型为“ 其他账户 ”时，需要手动输入对端账户的账号ID和私有网络的ID。

4) 选择带宽上限

- 同地域对等连接带宽无上限，**不可修改**。

5) 同账户内私有网络进行连接，新建后对等连接立即生效；
   与其他账户私有网络创建对等连接，需要对端接受此对等连接后生效。


#### （可选）第二步：接受对等连接
如果VPC2是其它用户的私有网络，您需要通知该用户接受您的对等连接申请。
1) 登录[云平台控制台](http://console.tcecqpoc.fsphere.cn/)，点击导航条【私有网络】，在私有网络控制台选择【对等连接】。
2) 在列表上方选择对应的**地域：上海**，找到您对等连接列表中待接受的对等连接：`PeerConn`，点击【接受】。
3) 对等连接完成建立。
>注：对等连接建立后，本端和对端私有网络**无法**直接互访，您还需在**双方**私有网络中添加指向对等连接的路由，才可以互通。

#### 第三步：为对等连接配置本端和对端路由表
1) 登录[云平台控制台](http://console.tcecqpoc.fsphere.cn/)，点击导航条【私有网络】，在私有网络控制台选择【子网】选项卡。
2) 点击您对等连接本端指定子网（子网A）的关联路由表的ID（路由表A），进入路由表的详情页。
3) 点击编辑路由策略。目的端中填入对端 CIDR（`10.0.1.0/24`） ，下一跳类型选择【对等连接】，下一跳选择已建立的对等连接（PeerConn）。
4) 保存路由表。
**对端路由表的配置同上。**
>注：
1）您一定要在本端和对端都配置相关路由，才可以通过对等来接通信。
2) 两个私有网络之间本端多个网段与对端多个网段通信，只需要**增加对应的路由表项**，不需要建立多个对等连接。

路由表配置完成后，不同私有网络的网段之间即可进行通信。

### 查看对等连接相关的路由策略
1) 登录[云平台控制台](http://console.tcecqpoc.fsphere.cn/)，点击导航条【私有网络】，在私有网络控制台选择【对等连接】。
2) 在列表上方筛选地域和私有网络。
3) 点击指定对等连接的ID，进入对等连接详情页，在相关路由策略中即可看到：下一跳是该对等连接的目的网段、关联子网以及相关路由表。
>注：如果您的建立了对等连接，但是无法通信，请先通过该步骤查看**本端和对端**路由表配置是否正确。

### 查看跨地域对等连接的网络流量**监控**数据
同地域对等连接的网络流量没有上限。
对等连接网络流量监控仅支持跨地域的。
1) 登录[云平台控制台](http://console.tcecqpoc.fsphere.cn/)，点击导航条【私有网络】，在私有网络控制台选择【对等连接】。
2) 在列表上方筛选地域和私有网络。
3) 点击指定对等连接的监控图标，即可查看**出入带宽、出入包量和丢包率**。


### 拒绝对等连接
您可以拒绝“待接受”状态的对等连接申请。除了您信任的账户以外，您可以拒绝任何不必要的请求。

1) 登录[云平台控制台](http://console.tcecqpoc.fsphere.cn/)，点击导航条【私有网络】，在私有网络控制台选择【对等连接】选项卡。
2) 查看您对等连接列表中待接受的对等连接，在操作栏中点击【拒绝】按钮。
3) 对等连接已拒绝并消失。

### 删除对等连接
对等连接的任何一方都可以随时删除对等连接，对等连接删除后立即失效。对等连接删除后将一同删除路由表中包含此对等连接的路由项。

1) 登录云平台控制台，点击导航条【私有网络】。
2) 在私有网络控制台选择【对等连接】选项卡，查看您对等连接列表中已连接的对等连接，在操作栏中点击【删除】按钮。
3) 确认删除后，对等连接即被删除。

### 查看对端账号ID
您在创建跨账号对等连接/共享专线时，需要输入对端**开发商**账号ID，查看方式如下：
1) 登录云平台控制台，点击右上角账号名称。
2) 查看【[个人信息](http://console.tcecqpoc.fsphere.cn/developer)】中的账号ID。
![](http://imgcache.tcecqpoc.fsphere.cn/image/mc.qcloudimg.com/static/img/d81098a69855b8461d67d181fbc4acdd/1.png)


### 删除对等连接
对等连接的任何一方都可以随时删除对等连接，对等连接删除后立即失效。对等连接删除后将一同删除路由表中包含此对等连接的路由项。

1) 登录云平台控制台，点击导航条【私有网络】。
2) 在私有网络控制台选择【对等连接】选项卡，查看您对等连接列表中已连接的对等连接，在操作栏中点击【删除】按钮。
3) 确认删除后，对等连接即被删除。

### 设置跨地域互联告警
1) 登录云平台控制台点击顶部导航条【云产品】-【监控与管理】-【云监控】，选择左导航栏内的【我的告警】-【[告警策略](http://console.tcecqpoc.fsphere.cn/monitor/policylist)】，点击：新增告警策略。
2) 填写告警策略名称，在策略类型中选择【对等连接】，然后添加告警触发条件。
3) 关联告警对象：选择告警接收组，保存后即可在告警策略列表中查看已设置的告警策略。
4) 查看告警信息：告警条件被触发后，您将接受到短信/邮件/站内信等通知，同时可以在左导航【我的告警】-【告警列表】中查看。



## API概览
您可以使用API操作来设置和管理您的对等连接，有关 VPC 内其他资源的更多内容，可以查看 [VPC 所有 API 概览](/document/api/215/909)。
 
 
| 接口功能 | Action ID |  功能描述 |
|---------|---------|---------|
| 创建同地域对等连接 | [CreateVpcPeeringConnection](/document/api/215/2107) | 创建同地域对等连接。 |
| 删除同地域对等连接 | [DeleteVpcPeeringConnection](/document/api/215/2104) | 删除同地域对等连接。 |
| 修改同地域对等连接 | [ModifyVpcPeeringConnection](/document/api/215/2103) | 修改同地域对等连接。 |
| 接受同地域对等连接 | [AcceptVpcPeeringConnection](/document/api/215/2106) | 接受同地域对等连接。 |
| 驳回同地域对等连接 | [RejectVpcPeeringConnection](/document/api/215/2105) | 驳回同地域对等连接。 |
| 启用过期同地域对等连接 | [EnableVpcPeeringConnection](/document/api/215/2102) | 启用过期同地域对等连接。 |
| 创建跨地域对等连接 | [CreateVpcPeeringConnectionEx](/document/api/215/4803) | 创建跨地域对等连接。 |
| 删除跨地域对等连接 | [DeleteVpcPeeringConnectionEx](/document/api/215/4804) | 删除跨地域对等连接。 |
| 修改跨地域对等连接 | [ModifyVpcPeeringConnectionEx](/document/api/215/4805) | 修改跨地域对等连接。 |
| 接受跨地域对等连接 | [AcceptVpcPeeringConnectionEx](/document/api/215/4806) | 接受跨地域对等连接。 |
| 驳回跨地域对等连接 | [RejectVpcPeeringConnectionEx](/document/api/215/4807) | 驳回跨地域对等连接。 |
| 启用过期跨地域对等连接 | [EnableVpcPeeringConnectionEx](/document/api/215/4808) | 启用过期跨地域对等连接。 |
| 查询对等连接 | [DescribeVpcPeeringConnections](/document/api/215/2101) | 查询对等连接。 |
